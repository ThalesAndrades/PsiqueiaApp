{
  "name": "Production Release",
  "description": "Build final para App Store com validaÃ§Ãµes completas",
  "trigger": {
    "push": {
      "branches": [
        "main",
        "master"
      ]
    },
    "tag": {
      "pattern": "v*.*.*"
    }
  },
  "environment": {
    "xcode": "15.2",
    "node": "18.x",
    "variables": [
      {
        "name": "NODE_ENV",
        "value": "production"
      },
      {
        "name": "CI",
        "value": "true"
      },
      {
        "name": "EXPO_PUBLIC_ENV",
        "value": "production"
      },
      {
        "name": "IOS_BUNDLE_IDENTIFIER",
        "value": "$IOS_BUNDLE_IDENTIFIER"
      },
      {
        "name": "DEVELOPMENT_TEAM",
        "value": "$DEVELOPMENT_TEAM"
      },
      {
        "name": "APP_STORE_CONNECT_API_KEY_ID",
        "value": "$APP_STORE_CONNECT_API_KEY_ID"
      },
      {
        "name": "APP_STORE_CONNECT_ISSUER_ID",
        "value": "$APP_STORE_CONNECT_ISSUER_ID"
      },
      {
        "name": "APP_STORE_CONNECT_PRIVATE_KEY",
        "value": "$APP_STORE_CONNECT_PRIVATE_KEY"
      }
    ]
  },
  "steps": [
    {
      "name": "Validate Release",
      "script": "set -e\necho \"ðŸ” Validando release...\"\n# Verificar se Ã© uma tag de versÃ£o vÃ¡lida\nif [[ \"$CI_TAG\" =~ ^v[0-9]+\\.[0-9]+\\.[0-9]+$ ]]; then\n  echo \"âœ… Tag de versÃ£o vÃ¡lida: $CI_TAG\"\nelse\n  echo \"âŒ Tag de versÃ£o invÃ¡lida. Use formato: v1.0.0\"\n  exit 1\nfi"
    },
    {
      "name": "Install Dependencies",
      "script": "set -e\necho \"ðŸ”§ Instalando dependÃªncias de produÃ§Ã£o...\"\nnpm ci --production=false\nnpx expo install --fix"
    },
    {
      "name": "Security Audit",
      "script": "set -e\necho \"ðŸ”’ Executando auditoria de seguranÃ§a...\"\nnpm audit --audit-level moderate\nnpm run security:check || echo \"âš ï¸ Security check nÃ£o configurado\""
    },
    {
      "name": "Run Complete Test Suite",
      "script": "set -e\necho \"ðŸ§ª Executando suite completa de testes...\"\nnpm run test:full || npm test -- --coverage --watchAll=false\nnpm run lint\nnpm run type-check || echo \"âš ï¸ Type checking nÃ£o configurado\"\nnpm run test:e2e || echo \"âš ï¸ Testes E2E nÃ£o configurados\""
    },
    {
      "name": "Build Production Assets",
      "script": "set -e\necho \"ðŸŽ¨ Construindo assets de produÃ§Ã£o...\"\nnpm run build:production || npm run build || echo \"âš ï¸ Build nÃ£o configurado\""
    },
    {
      "name": "Generate iOS Project",
      "script": "set -e\necho \"ðŸ“± Gerando projeto iOS para produÃ§Ã£o...\"\nnpx expo prebuild --platform ios --clean --no-install"
    },
    {
      "name": "Install CocoaPods",
      "script": "set -e\necho \"ðŸ« Instalando CocoaPods...\"\ncd ios\npod install --repo-update\ncd .."
    },
    {
      "name": "Validate Project Configuration",
      "script": "set -e\necho \"ðŸ” Validando configuraÃ§Ã£o do projeto...\"\ncd ios\n# Verificar Bundle ID\ngrep -q \"com.psiqueia.app\" PsiqueiaApp/Info.plist || {\n  echo \"âŒ Bundle ID incorreto no Info.plist\"\n  exit 1\n}\necho \"âœ… ConfiguraÃ§Ã£o do projeto validada\""
    },
    {
      "name": "Build and Archive for Production",
      "script": "set -e\necho \"ðŸ—ï¸ Construindo versÃ£o de produÃ§Ã£o...\"\ncd ios\nxcodebuild -workspace ios/PsiqueiaApp.xcworkspace \\\n  -scheme PsiqueiaApp \\\n  -configuration Release \\\n  -destination generic/platform=iOS \\\n  -archivePath PsiqueiaApp.xcarchive \\\n  -allowProvisioningUpdates \\\n  archive"
    },
    {
      "name": "Export for App Store",
      "script": "set -e\necho \"ðŸ“¤ Exportando para App Store...\"\ncd ios\nxcodebuild -exportArchive \\\n  -archivePath PsiqueiaApp.xcarchive \\\n  -exportPath ./build \\\n  -exportOptionsPlist exportOptions.plist \\\n  -allowProvisioningUpdates"
    },
    {
      "name": "Upload to App Store",
      "script": "set -e\necho \"ðŸš€ Enviando para App Store...\"\ncd ios\nxcrun altool --upload-app \\\n  --type ios \\\n  --file \"./build/PsiqueiaApp.ipa\" \\\n  --apiKey $APP_STORE_CONNECT_API_KEY_ID \\\n  --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \\\n  --verbose"
    },
    {
      "name": "Create Release Notes",
      "script": "set -e\necho \"ðŸ“ Criando notas de release...\"\necho \"Release $CI_TAG enviado para App Store\" > release-notes.txt\necho \"Build: $CI_BUILD_NUMBER\" >> release-notes.txt\necho \"Commit: $CI_COMMIT_SHA\" >> release-notes.txt\necho \"Data: $(date)\" >> release-notes.txt"
    }
  ]
}